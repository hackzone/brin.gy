{% extends "base.html" %}

{% block title %}
manage log
{% endblock %}

{% block content %}
<div>
    <div id="debug" style="position:absolute"></div>
    <div id="graph" style="position:absolute;overflow:hidden;left:200px;top:100px;width:500px;height:400px;background-color:#ffffff;border:2px solid #bbbb22"></div>
</div>

{% endblock %}

{% block extra_scripts %}
    <script language="JavaScript" src='{% url resources "scripts/jsviz/0.3.3/geometry/SnowflakeGraphModel.js" %}'></script>
    <script language="JavaScript" src='{% url resources "scripts/jsviz/0.3.3/layout/graph/SnowflakeLayout.js" %}'></script>
    <script language="JavaScript" src='{% url resources "scripts/jsviz/0.3.3/layout/view/HTMLGraphView.js" %}'></script>
    <script language="JavaScript" src='{% url resources "scripts/jsviz/0.3.3/layout/view/SVGGraphView.js" %}'></script>

    <script language="JavaScript" src='{% url resources "scripts/jsviz/0.3.3/util/Timer.js" %}'></script>
    <script language="JavaScript" src='{% url resources "scripts/jsviz/0.3.3/util/EventHandler.js" %}'></script>

    <script language="JavaScript" src='{% url resources "scripts/jsviz/0.3.3/io/DataGraph.js" %}'></script>
    <script language="JavaScript" src='{% url resources "scripts/jsviz/0.3.3/io/HTTP.js" %}'></script>
    <script language="JavaScript" src='{% url resources "scripts/jsviz/0.3.3/io/XMLTreeLoader.js" %}'></script>
    <script language="JavaScript">
        $(document).ready(function() {
                var TIMEDBUILD = window.location.href.indexOf("TIMEDBUILD")>0 ? true : false;

                
                
                /* 1) Create a new SnowflakeLayout.
                 *
                 * If you're going to place the graph in an HTML Element, other
                 * than the <body>, remember that it must have a known size and
                 * position (via element.offsetWidth, element.offsetHeight,
                 * element.offsetTop, element.offsetLeft).
                 */
                var layout = new SnowflakeLayout( document.getElementById("graph"), true );
                layout.view.skewBase=400;
                layout.setSize();

                /* 2) Configure the layout.
                 *
                 * This configuration defines how we handle the addition of
                 * different kinds of nodes to the graph. For each "type" of
                 * node, we tell the layout how to create a "model" and "view"
                 * of the new node.
                 */

                
                layout.config._default = {
                    
                /* The "model" defines the underlying structure of our graph.
                 * For a SnowflakeModel, we need to define the following for
                 * each node:
                 *
                 * - childRadius: the edge length to this node's children
                 * - fanAngle: the maximum angle in which child nodes will be
                 *   layed out
                 * - rootAngle: the base angle of the graph at the origin (this
                 *   is automatically determined for all child nodes)
                 *
                 * These parameters determine how this new node will interact
                 * with other nodes in our graph. The "model" attribute of a
                 * class in our configuration must return a JavaScript Object
                 * containing these values.
                 */

                    model: function( dataNode ) {
                        return {
                            childRadius: 40,
                            fanAngle: dataNode.root ? 360: 100,
                            rootAngle: 0
                        }
                    },

                /* The "view" defines what the nodes in our graph look like.
                 * The "view" attribute of a class must return a DOM element --
                 * JSViz supports most HTML and SVG elements. You can control
                 * the appearence and behavior of view elements just like any
                 * DOM element:
                 *
                 * CSS: Point to a CSS style sheet using the "className"
                 * attribute of the DOM element.
                 *
                 * Contents: Indicate the node's contents, in HTML, using the
                 * "appendChild" function or by setting DOM element's innerHTML.
                 *
                 * Behavior: Add an event handler using the EventHandler factory
                 * class. For example:
                 *
                 * nodeElement.onclick = new EventHandler( _caller, _handler, arg0, arg1... );
                 *
                 * where _caller is an object instance that _handler may refer
                 * to as "this" (use "window" if the function is in the global
                 * scope), _handler is the function to be executed, and any
                 * additional arguments are passed as parameters to _handler.
                 */

                    view: function( dataNode, modelNode ) {
                        if ( layout.svg ) {
                            var nodeElement = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                            nodeElement.setAttribute('stroke', '#888888');
                            nodeElement.setAttribute('stroke-width', '1px');
                            nodeElement.setAttribute('fill', dataNode.color);
                            nodeElement.setAttribute('r', 10 + 'px');
                            nodeElement.onmousedown =  new EventHandler( layout, layout.handleMouseDownEvent, modelNode.id )
                            return nodeElement;
                        } else {
                            var nodeElement = document.createElement( 'div' );
                            nodeElement.style.position = "absolute";
                            nodeElement.style.width = "12px";
                            nodeElement.style.height = "12px";

                            var color = dataNode.color.replace( "#", "" );
                            nodeElement.style.backgroundImage = "url(http://kylescholz.com/cgi-bin/bubble.pl?title=&r=12&pt=8&b=888888&c=" + color + ")";
                            nodeElement.innerHTML = '<img width="1" height="1">';
                            nodeElement.onmousedown =  new EventHandler( layout, layout.handleMouseDownEvent, modelNode.id )
                            return nodeElement;
                        }
                    }
                }

                /* 3) Override the default edge properties builder.
                 *
                 * This is optional of course, but we'll create a custom edge
                 * builder that draws edges in the color of the parent node.
                 *
                 * @return Object
                 */
                layout.viewEdgeBuilder = function( dataNodeSrc, dataNodeDest ) {
                    if ( this.svg ) {
                        return {
                            'stroke': dataNodeSrc.color,
                            'stroke-width': '2px',
                            'stroke-dasharray': '6,4'
                        }
                    } else {
                        return {
                            'pixelColor': dataNodeSrc.color,
                            'pixelWidth': '20px',
                            'pixelHeight': '2px',
                            'pixels': 8
                        }
                    }
                }

                /* 4) Make an loader to process the contents of our file.
                 *
                 * Here, we're using the XMLTreeLoader.
                 */
                var loader = new XMLTreeLoader( layout.dataGraph );
                loader.load( '{% url resources "scripts/jsviz/0.3.3/treedata1.xml" %}' );

                /* 5a) Control the addition of nodes and edges with a timer.
                 *
                 * This enables the graph to start organizng as data is loaded.
                 * Use a larger tick time for smoother animation, but slower
                 * build time.
                 */

                if ( TIMEDBUILD ) {
                    var buildTimer = new Timer( 0 );
                    buildTimer.subscribe( layout );
                    buildTimer.start();

                /* 5b) Or ... Add all nodes at once.
                 *
                 * Use a timer and simple build class to load all nodes when
                 * they are available then stop polling for new nodes.
                 */
                } else {
                    var SimpleBuilder = function() {
                        
                        this.started = false;
                        this.update = function() {
                            var d = layout.dequeueNode();
                            if ( !this.started && d ) {
                                this.started=true;
                                while( layout.dequeueNode() ) {};
                            }
                            if ( this.started && !d ) { return false; }
                        }
                    }
                    var buildTimer = new Timer(0);
                    buildTimer.subscribe( new SimpleBuilder );
                    buildTimer.start();
                }
        });
    </script>

{% endblock %}