{% extends "base.html" %}


{% block head %}
<script language="javascript" type="text/javascript">


var ego_url_prefix = "{{ego_url_prefix}}";
var website_url_prefix = "{{website_url_prefix}}";
var valid_username = undefined;

var check_username = function()
{
    username = $("#username").val();
    
    $.getJSON(ego_url_prefix+"/"+username, function(json){
        if (username && username != "<username>" && typeof json == "object" && json.error) {
            $("#btn").html("get it!").removeClass("primary").addClass("success");
            valid_username = username;
        } else {
            $("#btn").html("check").removeClass("primary success").addClass("danger").html("pseudonym taken!");
            valid_username = undefined;
        }
    });
}

var post_new_user = function() {
    $.post(ego_url_prefix, {username:valid_username}, function(data) {
        error = data.error;
        if (data.error)
            alert(data.error);
        
        if (! error.length) {
            window.location.href = "{{website_url_prefix}}/manage/"+valid_username+"#tour";
        }
    }, "json");
}

$(document).ready(function()
{
    $("#newuserform").submit(function(obj){
        username = $("#username").val();
        res = /\W/.test(username);
        
        if (res) {
            valid_username = undefined;
            $("#btn").removeClass("primary success").addClass("danger").html("Please use only letters and/or numbers");
        } else {
            if (valid_username) {
                post_new_user();
            } else {
                check_username();
            }
        }
        return false;
    });
    
    $("#btn").click(function (){
        $("#newuserform").trigger("submit");
    });
    
    $("#username").focus().keydown(function(obj){
        if (obj.metaKey || obj.altKey || obj.ctrlKey)
            return false;
    }).keyup(function(obj) {
//         console.log(obj.keyCode);
//         text = $(this).val();
//         console.log("checking", text);
        if ($(this).val().length)
            check_username();
        else
            $("#btn").html("check").removeClass("danger success").addClass("primary").html("check");
        return true;
    });
    
    for (name in cookies.get_cookie()) {
        $("select").append("<option>"+name+"</option>")
        $("#previous_pseudonym").show();
    }
    
    $("select").change(function(){
        window.location.href = "{{website_url_prefix}}/manage/"+$(this).val();
    });
    $("#btn2").click(function(){
        window.location.href = "{{website_url_prefix}}/manage/"+$("select").val()+"#tour";
    });
});
</script>
{% end %}

{% block body %}

<div id="left">
    <h2>What it is</h2>
    <p>Brin.gy allows people to announce bits of information about themselves and find others based on that information. It implements an experimental protocol for human discovery, namely <b>Human Discovery Protocol</b>. HDP allows us to form dynamic groups such as the group of people interested in buying the same product, people with similar expertise, people in the same location, or any intersection of these examples.</p>
</div>

<div id="right">
    <div id="new_pseudonym">
        <h2>Pick a pseudonym</h2>
        <form method="post" id="newuserform">
            <input class="span2" id="username" name="username" type="text" value="" />
            <a id="btn" class="btn primary" href="#">check</a>
        </form>
    </div>
    <div id="previous_pseudonym">
        <h2>Previous pseudonyms</h2>
        <form>
            <select class="span2"></select>
            <a id="btn2" class="btn primary" href="#">choose</a>
        </form>
    </div>
</div>

{% end %}





