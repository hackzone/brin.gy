{% extends "base.html" %}

{% block head %}
{% autoescape None %}

<script language="javascript" type="text/javascript">

///////////////////////////////////
//////        START SUGGESTION BOX

suggestion_box = {};
suggestion_box.data = {};

suggestion_box.fetch_data = function(key, val, obj)
{
    val = val.toLowerCase();
    
    $.getJSON(E.satellite.url+"/profile/complete/"+key+"/"+val, function(json){
        suggestion_box.data = {};
        for (i in json.matches) {
            val = json.matches[i][0];
            card = json.matches[i][1];
            suggestion_box.data[val] = card;
        }
        suggestion_box.show_suggestions(obj);
    });
};

suggestion_box.show_suggestions = function(obj)
{   
    if( ! $("#dropdown").length ) {
        offset = obj.offset();
        _top = offset.top + obj.height() + 10;
        _left = offset.left;
        width = 100;
        
        css = {top:_top, left:_left, border:"1px solid #dddddd", backgroundColor:"white"};
        dropdown = $("<div id='dropdown'></div>").css(css).addClass("flying medium");
        $("body").append(dropdown);
    }
    
    $("#dropdown").empty();
    
    for (sug in suggestion_box.data) {
        val = $("<a></a>").html(sug).attr("sug",sug).addClass("suggestionVal");
        val.click(function(){
            obj.val($(this).attr("sug"));
            obj.trigger("keydown", [{obj:{keyCode:13}}]);
            return false;
        });
        card = $("<span></span>").html(suggestion_box.data[sug]).addClass("label suggestionCard");
        entry = $("<div></div>").addClass("suggestionEntry");
        entry.append(val).append(card);
        $("#dropdown").append(entry);
    }
};

suggestion_box.hide_suggestions = function(obj)
{
//     console.log( "closing" );
    $("#dropdown").remove();
};


Object.size = function(obj) {
    var size = 0, key;
    for (key in obj) {
        if (obj.hasOwnProperty(key)) size++;
    }
    return size;
};

//////        END SUGGESTION BOX
////////////////////////////////

// sdata example:
// profile = {
//      languages: {
//              enabled: false,
//              cnt: 109,
//              matches: {},
//              values: {
//                      greek: {
//                              cnt: 9,
//                              haveit: true,
//                              enabled: false,
//                              matches: {},
//                      },
//              },
//      },
// }

attr_manager = {};
// attr_manager.udata = {};
attr_manager.sdata = {
    profile:{},
    location:{
        "my location":{cnt:0, values:{}, enabled:0, matches:{}},
//         "destination":{},
    },
    buysell:{
        "product":{},
    },
};

attr_manager.add_sdata = function(cap, key, cnt) {
    if (cap==undefined || key==undefined || cnt==undefined){
        console.log("*** add_sdata: undefined var:", cap, key, cnt);
        return;
    }
    if (attr_manager.sdata[cap] == undefined)
        attr_manager.sdata[cap] = {};
    
    attr_manager.sdata[cap][key] = {cnt:0, values:{}, enabled:0, matches:{}};
}


E = {};
E.monitor = {
    "user_matches":{
        "by_keyval": {},
        "intersection": [],
    },
};

// E.caps = {};
// holds the keys to appear on the left pane

E.satellite = {};
E.satellite.url = "{{discov_url}}";
E.agent = {};
E.agent.id = "{{args}}";
E.agent.baseurl = "{{ego_url_prefix}}";
E.agent.url = "{{ego_url_prefix}}/{{args}}";
E.website_url = "{{website_url_prefix}}";

E.post_keyval = null;
// save key/val to agent.
E.delete_keyval = null;
// delete key/val to agent

E.generate_entry = null;
// generates UI profile element. 
// Arguments: key, val (optional for new pairs)

E.set_matches = null;
// animates the counter button of intersected matches to target value

E.populate_attrs = null;
// Show available attributes tab on left pane. Uses values stored in E.monitor 

E.poll_matches = null;
E.fetch_keyvals = null;
// fetch next batch of profiles attributes. 
// Uses E.caps to store fetched attributes.
E.last_fetched = ""; 
// keeps track of the last attribute fetched to continue from the next one

///////////////////////////////////////////////


E.post_keyval = function(cap, key, val, clb) {
    data = JSON.stringify([[key, val]]);
    if (clb == undefined)
        clb = function(json){
            console.log("post", json);
        }
    $.post(E.agent.url+"/"+cap, {data:data}, clb, "json");
}

E.delete_keyval = function(cap, key, val, clb) {
    if (clb == undefined)
        clb = function(json){
            console.log("post", json);
        }

    data = JSON.stringify([[key, val]]);
    $.ajax({
        type: "DELETE",
        url: E.agent.url+"/"+cap,
        data: {data:data},
        success: clb,
        dataType: "json",
    });
}


E.populate_map = function(p)
{
    var myLatlng = new google.maps.LatLng(p.lat, p.lon);
    var myOptions = {
        zoom: 14,
        center: myLatlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

    var marker = new google.maps.Marker({
        position: myLatlng, 
        map: map,
        title:"You are here!",
    });
    
    var infowindow = new google.maps.InfoWindow({
        content: "",
    });
    
    infowindow.setContent("tester");
    
    google.maps.event.addListener(marker, 'click', function() {
        infowindow.open(map,marker);
    });
}

E.set_matches = function(stop) {
    if (stop == undefined)
        stop = parseInt($("#matches").attr("curpos"));
    else
        $("#matches").attr("curpos", stop);
    
    start = parseInt($("#matches").html());
    step = 1;
    if (Math.abs(start-stop) > 10) { step = 10 }
    if (Math.abs(start-stop) > 100) { step = 100 }
    if (Math.abs(start-stop) > 1000) { step = 1000 }
    if (start > stop) {
        $("#matches").html(start-step);
        setTimeout(E.set_matches, 20);
    }
    if (start < stop) {
        $("#matches").html(start+step);
        setTimeout(E.set_matches, 20);
    }
}

E.handle_key_click = function(){
    cap = $(this).attr("cap");
    key = $(this).attr("key");
    
    pressed = $(this).hasClass("pressed");
    attr_manager.sdata[cap][key].enabled = !pressed;
    if (pressed) {
        $(this).removeClass("pressed");
    } else {
        $(this).addClass("pressed");
        $(this).siblings("div").children().children().removeClass("pressed");
        for (val in attr_manager.sdata[cap][key].values)
            attr_manager.sdata[cap][key].values[val].enabled = false;
    }
    E.poll_matches();
    return false;
}

E.handle_val_click = function(){
    cap = $(this).attr("cap");
    key = $(this).attr("key");
    val = $(this).attr("val");
    
    pressed = $(this).hasClass("pressed");
    attr_manager.sdata[cap][key].values[val].enabled = !pressed;
    if (pressed) {
        $(this).removeClass("pressed");
    } else {
        $(this).addClass("pressed");
        $(this).parent().parent().siblings("a").removeClass("pressed");
        attr_manager.sdata[cap][key].enabled = false;
    }
    E.poll_matches();
    return false;
}

E.handle_userattr_toggle =function(){
    cap = $(this).attr("cap");
    key = $(this).attr("key");
    val = $(this).attr("val");
    
    E.location_clb = function(result) {
        modal = $("#modal-from-dom");
        clearTimeout(E.modal_timer);
        modal.modal("hide");
    //     result.threshold = 0.0002;
        
        console.log(result);
    //     E.post_keyval("location", "my location", result);
    //     E.populate_map(JSON.parse(val));
    //     E.update_monitor();
    }
    
    if (cap == "location" && attr_manager.sdata[cap][key].values[val].haveit == false) {
        geogy.init(E.location_clb);
        
        show_modal = function() {
            modal = $("#modal-from-dom");
            modal.modal({backdrop:"static", show:true, keyboard:true});
            
            $("#modal-cancel-btn").click(function(){
                modal.bind('hidden', function(){
                    console.log("going to",E.website_url+"/manage/asdf");
                    console.log("should go to", window.location);
//                     location.replace(E.website_url+"/manage/asdf");
                });
                modal.modal("hide");
            });
        }
        
        E.modal_timer = setTimeout(show_modal, 500);
    }
    
    that = $(this);
    complete_toggle_handle
    complete_toggle_handle = function(that) {
        haveit = !attr_manager.sdata[cap][key].values[val].haveit;
        attr_manager.sdata[cap][key].values[val].haveit = haveit;
        if (haveit) {
            E.post_keyval(cap, key, val, function(){
                that.html("\u2713").popover("hide").css("background-color","");
                
                confirmation = $(".confirmation").html("added to your profile!");
                confirmation.addClass("success").removeClass("important").show();
                confirmation.offset(that.offset());
                
                confirmation.animate({"left":"+=30px","top":"-=50px"}, "slow", function(){ 
                    $(this).animate({"left":"+=0px"}, function(){
                        $(this).hide();
                    });
                });
            });
        } else {
            E.delete_keyval(cap, key, val, function(json){
                that.html("\u00A0").popover("hide").css("background-color","");
                
                confirmation = $(".confirmation").html("removed");
                confirmation.addClass("important").removeClass("success").show();
                confirmation.offset(that.offset());
                
                confirmation.animate({"left":"+=30px","top":"-=50px"}, "slow", function(){ 
                    $(this).hide();
                });
            });
        }
    }
    return false;
}

E.handle_userattr_hover_in = function(){
    cap = $(this).attr("cap");
    key = $(this).attr("key");
    val = $(this).attr("val");
    
    color = "green";
    text = "+";
    if (attr_manager.sdata[cap][key].values[val].haveit) {
        color = "red";
        text = "-";
    }
    
    $(this).html(text).css("background-color",color);
};

E.handle_userattr_hover_out = function(){
    cap = $(this).attr("cap");
    key = $(this).attr("key");
    val = $(this).attr("val");
    
    text = "\u00A0";
    if (attr_manager.sdata[cap][key].values[val].haveit) {
        text = "\u2713";
    }
    $(this).html(text).css("background-color","");
}

E.populate_attrs = function() {
    $("#choices").empty();
    
    console.log(attr_manager.sdata.location);
//     if (attr_manager.sdata.location["my location"].values == undefined)
//         attr_manager.sdata.location["my location"] = {}
    
    for (capname in attr_manager.sdata) {

        app = $("<div>"+capname+"</div>").addClass("clear");
        $("#choices").append(app).addClass("");
        for (attr in attr_manager.sdata[capname]) {
            
            // attr_counters class is used to group and iterate through all attribute counters
            count = $("<span></span>").addClass("count attr_counters");
            count.html(attr_manager.sdata[capname][attr].cnt);
            count.attr({uitype:"sat_attribute", cap:capname, key:attr});
            
            attribute = $("<span></span>").html(attr);
            pair = {cap:capname, key:attr};
            keypart = $("<a href='#'></a>").append(attribute);
            keypart.append(count).attr(pair);
            keypart.click(E.handle_key_click);
            
            valpart = $("<div class='valpart'></div>");
            for (val in attr_manager.sdata[capname][attr].values) {
                count = $("<span></span>").addClass("count attr_counters");
                count.html(attr_manager.sdata[capname][attr].cnt);
                count.attr({
                    uitype:"user_attribute", cap:capname, key:attr, val:val,
                });
                count.addClass("attr_counters").attr(attr);
                count.twipsy({title:function(){
                    cap = $(this).attr("cap");
                    key = $(this).attr("key");
                    val = $(this).attr("val");
                    cnt = attr_manager.sdata[cap][key].values[val].cnt;
                    text = " people";
                    if (cnt == 1)
                        text = " person";
                    return cnt+text;
                }, placement:"left", offset:5});
                
                trimmed = val;
                if (val.length > 10)
                    trimmed = val.substring(0,8)+"...";
                    
                value = $("<span class='value'></span>").html(trimmed);
                
                pair = {cap:capname, key:attr, val:val};
                value_pill = $("<a href='#'></a>").attr(pair).click(E.handle_val_click);
                value_pill.append(count).append(value);
                
                // ****** add_btn ****** add_btn ****** add_btn ******
                add_btn = $("<span class='add_btn' title='the title' data-content='the content'></span>").attr(pair);
                
                add_btn.click(E.handle_userattr_toggle);
                
                // ****** HOVER ****** HOVER ****** HOVER ******
                add_btn.hover(E.handle_userattr_hover_in, E.handle_userattr_hover_out);
                
                text = "\u00A0";
                if (attr_manager.sdata[capname][attr].values[val].haveit) {
                    text = "\u2713";
                }
                
                // ****** POPOVER ****** POPOVER ****** POPOVER ******
                add_btn.html(text).popover({title:function(){
                    return $(this).attr("key")+": "+$(this).attr("val");
                }, content:function(){
                    cap = $(this).attr("cap");
                    key = $(this).attr("key");
                    val = $(this).attr("val");
                    
                    if (attr_manager.sdata[cap][key].values[val].haveit)
                        return "Remove this from your profile.";
                    else
                        return "Add this to your profile.";
                }, offset:15});
                
                
                value_container = $("<div class='valcontainer'></div>");
                value_container.append(value_pill).append(add_btn);
                valpart.append(value_container);
            }
            pill = $("<pill></pill>").append(keypart).append(valpart);
            
            app.append(pill);
        }
        
        // specifically for profile, add a pill for new keys
//         if (capname == 'profile') {
//             pill_content = $("<a href='#'>create new attribute...</a>").attr("cap",capname).click(E.add_new_attribute);
//             pill = $("<li class='green_pill'></li>").append(pill_content);
//             $("#choices").append(pill);
//         
//             more = $("<a href='#'>fetch more...</a>").click(function(){
//                 E.fetch_keyvals();
//                 return false;
//             });
//             $("#choices").append(more);
//         }
    }
}

//////////////////////////////////////////////////



//////////////////////////////////////////////////

E.construct_result_enty = function(agent, picture) {
    console.log(agent, typeof(agent));
    pic = $("<img src='"+picture+"' width=20 style='float:left; clear:left;' />");
    username = $("<span style='margin-left:5px'></span>").html(agent);
    entry = $("<div></div>").append(pic).append(username);
    return entry;
}

E.get_multi_profile = function(agents) {
    if (agents.length > 0) {
        $.getJSON(E.agent.baseurl+"/batch_profile", {data:JSON.stringify(agents)}, function(json){
            $("#results").empty();
            for (agent in json.profiles) {
                
                obj = {};
                for (i in json.profiles[agent].data) {
                    key = json.profiles[agent].data[i].key;
                    val = json.profiles[agent].data[i].val;
                    obj[key] = val;
                }
                
                picture = "http://pldb.media.mit.edu/research/images/nophoto.gif";
                if (obj["company"]=="Media Lab")
                    picture = "http://pldb.media.mit.edu/face/"+agent;
                if ("picture" in obj)
                    picture = obj.picture;
                
                entry = E.construct_result_enty(agent, picture);
                $("#results").append(entry);
            }
        });
    }
}

E.poll_matches = function() {
    
    query = [];
    E.match_criteria = [];
    for (cap in attr_manager.sdata)
        for (key in attr_manager.sdata[cap]) {
            query.push([cap, key, ""]);
            for (val in attr_manager.sdata[cap][key].values) {
                query.push([cap, key, val]);
                E.match_criteria.push([cap, key, val]);
            }
        }
    
    data = JSON.stringify(query);
//     data = escape(data);
    
    $.getJSON(E.satellite.url+"/multimatch", {data:data}, function(json){
        E.monitor.user_matches.by_keyval = {};
        
        for (i in json.matches) {
            
            match = json.matches[i];
            
            cap = match[0];
            key = match[1];
            val = match[2];
            cnt = match[3];
            matches = match[4];
            
            if (val.length > 0) {
                attr_manager.sdata[cap][key].values[val].cnt = cnt;
                attr_manager.sdata[cap][key].values[val].matches = matches;
//                 E.monitor.user_matches.by_keyval[key+"_"+val] = matches;
            } else {
                attr_manager.sdata[cap][key].cnt = cnt;
                attr_manager.sdata[cap][key].matches = matches;
            }
        }
        
        test_intersection = {};
        target_count = 0
        
        for (cap in attr_manager.sdata) {
            for (key in attr_manager.sdata[cap]) {
                for (val in attr_manager.sdata[cap][key].values) {
                    if (attr_manager.sdata[cap][key].values[val].enabled) {
                        for (i in attr_manager.sdata[cap][key].values[val].matches) {
                            agent = attr_manager.sdata[cap][key].values[val].matches[i];
                            if (test_intersection[agent] == undefined)
                                test_intersection[agent] = 0;
                            test_intersection[agent] += 1;
                        }
                        target_count += 1;
                    }
                }
                if (attr_manager.sdata[cap][key].enabled) {
                    for (i in attr_manager.sdata[cap][key].matches) {
                        agent = attr_manager.sdata[cap][key].matches[i];
                        if (test_intersection[agent] == undefined)
                            test_intersection[agent] = 0;
                        test_intersection[agent] += 1;
                    }
                    target_count += 1;
                }
            }
        }
        
//         console.log(test_intersection, target_count);
        
        intersection = [];
        for (match in test_intersection)
            if (test_intersection[match] == target_count)
                if (match != E.agent.id)
                    intersection.push(match);
        
        
        E.get_multi_profile(intersection);
        
        E.monitor.user_matches.intersection = intersection;
        
        E.set_matches(Object.size(intersection));
        
        $(".attr_counters").each(function(){
            if ($(this).attr("uitype") == "sat_attribute") {
                cap = $(this).attr("cap");
                key = $(this).attr("key");
                $(this).html( attr_manager.sdata[cap][key].cnt );
            }
            
            if ($(this).attr("uitype") == "user_attribute") {
                cap = $(this).attr("cap");
                key = $(this).attr("key");
                val = $(this).attr("val");
                
                if (attr_manager.sdata[cap][key] == undefined ||
                    attr_manager.sdata[cap][key].values[val] == undefined) {
                    $(this).remove();
                    cnt = 0;
                } else {
                    cnt = attr_manager.sdata[cap][key].values[val].cnt;
                    $(this).html(cnt);
                }
            }
        });
    });
}

E.fetch_keyvals = function(clb) {
    starting_from = E.last_fetched;
    
    if (E.last_fetched.length)
        console.log("continuing from", E.last_fetched);
    
    data = JSON.stringify({with_values:1, user:E.agent.id});
    
    $.getJSON(E.satellite.url+"/profile/fetch/"+starting_from, {data:data}, function(json){
        console.log("fetch", json);
        for (attribute in json.matches) {
            attr_manager.add_sdata("profile", attribute, 0);
            for (i in json.matches[attribute]) {
                val = json.matches[attribute][i][0];
                cnt = json.matches[attribute][i][1];
                haveit = json.matches[attribute][i][2];

                attr_manager.sdata.profile[attribute].values[val] = {
                    cnt:cnt, enabled:0, haveit:haveit, matches:{},
                };
            }
            E.last_fetched = attribute;
        }
        clb();
    });
    
    key = "my location";
    $.getJSON(E.satellite.url+"/location/fetch/"+E.agent.id+"/"+key, function(json){
        val = {lat:json.lat, lon:json.lon};
        valstr = JSON.stringify(val);
        
        haveit = false;
        if (json.lat.length > 0)
            haveit = true;
            
        attr_manager.add_sdata("location", key, 0);
        attr_manager.sdata.location[key].values[valstr] = {
            cnt:json.count, enabled:0, haveit:haveit, matches:json.matches,
        };

        clb();
    });
}

E.update_monitor = function() {
    if (window.location.search == "?control") {
        query = [];
        for (cap in attr_manager.udata)
            for (key in attr_manager.udata[cap])
                for (val in attr_manager.udata[cap][key]) {                
                    if (attr_manager.udata[cap][key][val].enabled == 1)
                        query.push([cap, key, val]);
                }
        data = JSON.stringify(query);
//         console.log(data);
        $.post(E.agent.baseurl+"/controller", {data:data, controller:E.agent.id}, function(json){
//             console.log("controller post:", json);
        }, "json");
    };
    return false;
}


var show_delete_modal = function() {
    modal = $("#delete-confirmation-modal");
    modal.modal({backdrop:"static", show:true, keyboard:true});
    
    $("#delete-cancel-btn").click(function(){
        modal.modal("hide");
    });
    $("#delete-delete-btn").click(function(){
        modal.bind('hidden', function(){
            console.log("deleting", E.agent.url);
            $.ajax({
                url: E.agent.url,
                type: "DELETE",
                success: function(json) {
                    console.log("delete response", json);
                    location.replace(E.website_url);
                },
                dataType: "json",
            });
        });
        modal.modal("hide");
        cookies.del_cookie(E.agent.id);
    });
}


//////////////////////////////////////////////////
////////////////     ON READY

$(document).ready(function()
{
    clb = E.populate_attrs;
    E.fetch_keyvals(clb);
    
    $("#match_btn").click(function(){
        $("#result_list").html("");
        for (i in E.monitor.user_matches.intersection) {
            agent = $("<div></div>");
            agent.html(E.monitor.user_matches.intersection[i]);
            $("#result_list").append(agent);
        }
        $("#map_canvas").toggle();
        console.log(E.monitor.user_matches.intersection);
        console.log(E.match_criteria);
        return false;
    });
    
    setInterval(E.poll_matches, 2000); 
    
    E.update_monitor();
    $("#delete_btn").show().click(show_delete_modal);
    $("#pseudonym").show();
    
    cookies.set_cookie(E.agent.id);
    
    $("nav a").click(function (){
        first_child_selected = $("nav a:first-child").hasClass("selected");
        if (first_child_selected) {
            $("nav a:first-child").removeClass("selected");
            $("nav a:last-child").addClass("selected");
        } else {
            $("nav a:first-child").addClass("selected");
            $("nav a:last-child").removeClass("selected");
        }
        return false;
    });
});



</script>
{% end %}
{% block body %}

        <div class="span5">
            <nav class="">
                <a href="#" class="selected">search</a>
                <a class="" href="#">me</a>
            </nav>
            <div id="choices"></div>
        </div>
        <div id="right_pane" class="span11 columns">            
            <div id="scratchpad">
            </div>
            
            <div id="results" class="span3"></div>
            
            <div class="map_container span8">
                <div id='map_canvas'></div>
                
                <button id="match_btn" class="btn info">
                    <div id="matches" curpos="0">0</div>
                    <div id="matches_caption"></div>
                </button>
            </div>
        </div>]



<div id="modal-from-dom" class="modal hide fade">
    <div class="modal-header">
        <a href="#" class="close">&times;</a>
        <h3>Currentt Location</h3>
    </div>
    <div class="modal-body">
        <p>To find others near you, please choose to share your location above.</p>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn danger" id="modal-cancel-btn">Cancel</a>
    </div>
</div>


<div id="delete-confirmation-modal" class="modal hide fade">
    <div class="modal-header">
        <a href="#" class="close">&times;</a>
        <h3>What?! Are you sure?</h3>
    </div>
    <div class="modal-body">
        <p>You understand that this is <b>not</b> Facebook,<br> if you delete this agent all associated data will <b>actually</b> be deleted ;)</p>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn danger" id="delete-delete-btn">Trash everything</a>
        <a href="#" class="btn primary" id="delete-cancel-btn">Cancel</a>
    </div>
</div>



<div class='confirmation label'></div>


{% end %}




