<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0px; padding: 0px }
  #map_canvas { height: 100% }
</style>
<script type="text/javascript"
    src="http://maps.google.com/maps/api/js?sensor=false">
</script>
<script type="text/javascript"
    src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js">
</script>
<script type="text/javascript">

var host_prefix = "http://localhost:10002";
var map;
var markers_by_agent = {};
var marker_list = [];

function clearMarkers() {
    for (i in markers_by_agent) {
        markers_by_agent[i].setMap(null);
    }
    for (i in marker_list) {
        marker_list[i].setMap(null);
    }
}

var set_icon = function(agent)
{
//     black, blue, green, grey, orange, pink, purple, red, and yellow
    color = "pink";
    icon = "http://gothere.sg/static/img/icons/api/";
//     icon = "http://maps.google.com/mapfiles/";
    icon = icon+ "marker";
    icon = icon+ "_"+color+"_";
    icon = icon+ String.fromCharCode(marker_list.length%26 + 65);
    icon = icon+ ".png";
    
    markers_by_agent[agent].setIcon(icon);
}

var create_marker = function(agent, lat, lon)
{
    var latlng = new google.maps.LatLng(lat, lon);
    
    if (markers_by_agent[agent] == undefined) {
        var marker = new google.maps.Marker({
            position: latlng,
            map: map,
            title: agent,
        });
        
        loc_url = host_prefix+"/"+agent+"/location";
        html = "<div><a href='"+loc_url+"'>"+agent+"</a></div>";
        var infowindow = new google.maps.InfoWindow({
            content: html
        });
        
        google.maps.event.addListener(marker, 'click', function() {
        infowindow.open(map,marker);
        });
        
        markers_by_agent[agent] = marker;
        marker_list.push(marker);
        
        set_icon(agent);
    } else {
        markers_by_agent[agent].setPosition(latlng);
    }
}

var reposition_marker = function(agent)
{
    url = host_prefix+"/"+agent+"/location";
    $.getJSON(url, function(json){
        create_marker(json.user, json.locations.lat, json.locations.lon)
    });
}

var query_agents = function()
{
    url = host_prefix+"/show_agents";
    $.getJSON(url, function(json){
        for (i in json.agents) {
            var agent = json.agents[i];
            
            reposition_marker(agent);
        }
    });
}

$(document).ready(function() {
    var latlng = new google.maps.LatLng(42.356,-71.1);

    var myOptions = {
            zoom: 17,
            center: latlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        
    map = new google.maps.Map(document.getElementById("map_canvas"),
        myOptions);
    
    var infowindow = new google.maps.InfoWindow({
        content: '<div id="content">asdf111</div>'
    });
    
    setInterval(query_agents, 2000);
});

</script>
</head>
<body>
  <div id="map_canvas" style="width:100%; height:100%"></div>
</body>
</html>